<?php

namespace App\Http\Controllers;


use Illuminate\Support\Facades\Http;
use App\Models\Plugin;

class VulnerabilityController extends Controller
{
    public function index()
    {

        $pluginsAll = Plugin::all();
        $plugins = [];

        foreach ($pluginsAll as $plugin) {
            $plugins[] = $plugin->slug;
        }

        $vulnerabilities = [];

        foreach ($plugins as $plugin) {
            $response = Http::get("https://www.wpvulnerability.net/plugin/{$plugin}/");

            if ($response->successful()) {
                $data = $response->json();

                if (!empty($data['data']['vulnerability'])) {
                    foreach ($data['data']['vulnerability'] as $vuln) {
                        $vulnerabilities[] = [
                            'plugin' => $plugin,
                            'version' => $vuln['operator']['max_version'] ?? 'N/A',
                            'description' => $vuln['source'][0]['description'] ?? 'Sin descripción',
                            'score' => $vuln['impact']['cvss']['score'] ?? 'Sin datos',
                            'severity' => $vuln['impact']['cvss']['severity'] ?? 'Sin datos'
                        ];
                    }
                }

            }

        }

        return view('vulnerabilities.index', compact('vulnerabilities'));
    }

    public function filterVulnerabilities()
    {
        $pluginsAll = Plugin::all();
        $plugins = [];

        // Obtener slugs y versiones de los plugins en la base de datos
        foreach ($pluginsAll as $plugin) {
            $plugins[$plugin->slug] = [
                'version' => $plugin->version,
                'name' => $plugin->name,
                'project_id' => $plugin->project
            ];
        }

        $vulnerabilities = [];

        foreach ($plugins as $plugin => $pluginData) {
            $response = Http::get("https://www.wpvulnerability.net/plugin/{$plugin}/");

            if ($response->successful()) {
                $data = $response->json();

                if (!empty($data['data']['vulnerability'])) {
                    foreach ($data['data']['vulnerability'] as $vuln) {
                        $vulnVersion = $vuln['operator']['max_version'] ?? 'N/A';

                        // Comparar versiones y filtrar
                        if ($vulnVersion !== 'N/A' && version_compare($vulnVersion, $pluginData['version'], '=')) {

                            if ($vuln['impact'] == []) { 
                                $vulnerabilities[] = [
                                    'plugin' => $pluginData['name'],
                                    'version' => $vulnVersion,
                                    'description' => $vuln['source'][1]['description'] ?? 'Sin descripción',
                                    'score' => $vuln['source'][0]['name'] ?? 'Sin datos',
                                    'severity' => $vuln['source'][0]['link'] ?? 'Sin datos',
                                    'project_id' => $pluginData['project_id']['name']
                                ];
                            }
                            else { 
                                $vulnerabilities[] = [
                                    'plugin' => $pluginData['name'],
                                    'version' => $vuln['operator']['max_version'] ?? 'N/A',
                                    'description' => $vuln['source'][0]['description'] ?? 'Sin descripción',
                                    'score' => $vuln['impact']['cvss']['score'] ?? 'Sin datos',
                                    'severity' => $vuln['impact']['cvss']['severity'] ?? 'Sin datos',
                                    'project_id' => $pluginData['project_id']['name']
                                ];
                            }
                        }
                    }
                }
            }
        }

        return view('vulnerabilities.vulnerabilities', compact('vulnerabilities'));
    }
}
